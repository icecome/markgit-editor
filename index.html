<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MarkGit Editor</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%233b82f6;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='8' fill='url(%23grad)'/%3E%3Cg fill='white'%3E%3Cpath d='M12 8v16h8V8h-8z'/%3E%3Cpath d='M8 12h16v8H8z'/%3E%3C/g%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script src="https://unpkg.com/lucide@0.344.0"></script>
    <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/vditor@3.10.4/dist/index.css">
    <script src="https://unpkg.com/vditor@3.10.4/dist/index.min.js"></script>
    <script src="https://unpkg.com/axios@1.6.7/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/main.css">
</head>
<body>
<div id="app">
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">
                <div class="logo-icon">
                    <i data-lucide="edit-3" style="width: 18px; height: 18px;"></i>
                </div>
                <span>MarkGit Editor</span>
            </div>
            <div class="nav-actions">
                <button class="btn btn-primary" @click="showNewFilePanel()">
                    <i data-lucide="plus" style="width: 14px; height: 14px;"></i>
                    <span>新建文件</span>
                </button>
                <button class="btn btn-success" @click="showChangesPanel()">
                    <i data-lucide="git-commit" style="width: 14px; height: 14px;"></i>
                    <span>提交</span>
                </button>
                <button class="btn btn-ghost" @click="initWorkspace()" title="初始化仓库（自动克隆远程仓库）">
                    <i data-lucide="git-branch-plus" style="width: 14px; height: 14px;"></i>
                    <span>初始化</span>
                </button>
                <button class="btn btn-ghost" @click="pullRepo()" title="拉取更新">
                    <i data-lucide="git-pull-request" style="width: 14px; height: 14px;"></i>
                    <span>拉取</span>
                </button>
                <button class="btn btn-ghost" @click="showThemePanel()" title="主题设置">
                    <i data-lucide="palette" style="width: 14px; height: 14px;"></i>
                </button>
                <button class="btn btn-ghost" @click="showConfigPanel()" title="设置">
                    <i data-lucide="settings" style="width: 14px; height: 14px;"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="sidebar-toggle" :class="{ 'collapsed': sidebarCollapsed }" @click="toggleSidebar">
            <i data-lucide="chevron-left" style="width: 14px; height: 14px;" v-if="!sidebarCollapsed"></i>
            <i data-lucide="chevron-right" style="width: 14px; height: 14px;" v-else></i>
        </div>

        <div class="sidebar" :class="{ 'collapsed': sidebarCollapsed }">
            <div class="sidebar-header">
                <div class="sidebar-title">文件浏览器</div>
                <div class="sidebar-actions">
                    <button class="btn btn-sm btn-secondary" @click="showNewFolderPanel()" title="在当前目录新建文件夹">
                        <i data-lucide="folder-plus" style="width: 12px; height: 12px;"></i>
                    </button>
                    <button class="btn btn-sm btn-secondary" @click="showNewFilePanel()" title="在当前目录新建文件">
                        <i data-lucide="file-plus" style="width: 12px; height: 12px;"></i>
                    </button>
                </div>
            </div>

            <div class="current-path-indicator" style="margin: 12px;">
                <i data-lucide="folder" style="width: 12px; height: 12px; display: inline; vertical-align: middle;"></i>
                当前目录：{{ currentDirectory || '根目录' }}
            </div>

            <div class="sidebar-content">
                <div v-if="loading" class="loading">
                    <div class="loading-spinner"></div>
                </div>
                <div v-else-if="fileTree.length === 0" class="empty-state">
                    <i data-lucide="folder-open" style="width: 32px; height: 32px;"></i>
                    <p>仓库为空</p>
                </div>
                <div v-else class="file-tree">
                    <tree-node
                        v-for="node in fileTree"
                        :key="node.path"
                        :node="node"
                        :level="0"
                        :expanded-paths="expandedPaths"
                        :selected-path="selectedFile ? selectedFile.path : ''"
                        :editing-path="editingFilePath"
                        :current-directory="currentDirectory"
                        @toggle="toggleExpand"
                        @select="selectFile"
                        @select-directory="selectDirectory"
                        @rename="showRenamePanel"
                        @delete="deleteFile"
                        @move="showMovePanel"
                        @contextmenu="showContextMenu"
                        @newfile="showNewFilePanelAt"
                        @newfolder="showNewFolderPanelAt"
                    ></tree-node>
                </div>
            </div>

            <div class="sidebar-footer">
                <div style="font-size: 12px; color: #9ca3af;">
                    <i data-lucide="git-branch" style="width: 12px; height: 12px; display: inline; vertical-align: middle;"></i>
                    {{ gitRepo ? gitRepo.split('/').pop().replace('.git', '') : '未配置' }}
                </div>
            </div>
        </div>

        <div class="main-content" :class="{ 'expanded': sidebarCollapsed }">
            <div class="content-area">
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <i data-lucide="file-text" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ fileCount }}</h3>
                            <p>文件总数</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <i data-lucide="folder" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ folderCount }}</h3>
                            <p>文件夹</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <i data-lucide="git-commit" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ changes.length }}</h3>
                            <p>待提交</p>
                        </div>
                    </div>
                </div>

                <div class="editor-container">
                    <div v-if="!editingFilePath" class="empty-state">
                        <i data-lucide="file-text" style="width: 48px; height: 48px;"></i>
                        <h3>选择文件开始编辑</h3>
                        <p>从左侧文件浏览器中选择一个文件</p>
                    </div>
                    <template v-else>
                        <div class="editor-header">
                            <div class="editor-file-info">
                                <i data-lucide="file-text" style="width: 16px; height: 16px; color: #3b82f6;"></i>
                                <span class="editor-file-path">{{ editingFilePath }}</span>
                                <span v-if="hasUnsavedChanges" class="unsaved-indicator">● 未保存</span>
                            </div>
                            <button class="btn btn-sm btn-success" @click="saveFile()" :disabled="saving">
                                <i data-lucide="save" style="width: 12px; height: 12px;"></i>
                                <span>{{ saving ? '保存中...' : '保存' }}</span>
                            </button>
                        </div>
                        <div class="editor-content">
                            <div id="vditor"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <div v-if="panelOpen" class="overlay" @click="closePanel"></div>

    <div class="side-panel" :class="{ 'open': panelOpen }">
        <div class="side-panel-header">
            <span class="side-panel-title">{{ panelTitle }}</span>
            <span class="side-panel-close" @click="closePanel">
                <i data-lucide="x" style="width: 18px; height: 18px;"></i>
            </span>
        </div>
        <div class="side-panel-content">
            <div v-if="panelType === 'newfile'">
                <div class="form-group">
                    <label class="form-label">文件名</label>
                    <input type="text" class="form-input" v-model="newFileName" placeholder="例如: my-post.md" @keyup.enter="createFile">
                    <p class="form-hint">将创建在：{{ currentDirectory || '根目录' }}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">文件内容（可选）</label>
                    <textarea class="form-textarea" v-model="newFileContent" placeholder="输入文件内容..."></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" @click="closePanel">取消</button>
                    <button class="btn btn-primary" @click="createFile">创建文件</button>
                </div>
            </div>

            <div v-if="panelType === 'newfolder'">
                <div class="form-group">
                    <label class="form-label">文件夹名</label>
                    <input type="text" class="form-input" v-model="newFolderName" placeholder="例如: my-folder" @keyup.enter="createFolder">
                    <p class="form-hint">将创建在：{{ currentDirectory || '根目录' }}</p>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" @click="closePanel">取消</button>
                    <button class="btn btn-primary" @click="createFolder">创建文件夹</button>
                </div>
            </div>

            <div v-if="panelType === 'rename'">
                <div class="form-group">
                    <label class="form-label">新名称</label>
                    <input type="text" class="form-input" v-model="renameNewName" @keyup.enter="renameFile">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" @click="closePanel">取消</button>
                    <button class="btn btn-primary" @click="renameFile">确认重命名</button>
                </div>
            </div>

            <div v-if="panelType === 'move'">
                <div class="form-group">
                    <label class="form-label">目标路径</label>
                    <input type="text" class="form-input" v-model="moveDestPath">
                    <p class="form-hint">原路径：{{ moveSourcePath }}</p>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" @click="closePanel">取消</button>
                    <button class="btn btn-primary" @click="moveFile">确认移动</button>
                </div>
            </div>

            <div v-if="panelType === 'config'">
                <div class="form-group">
                    <label class="form-label">Git 仓库地址</label>
                    <input type="text" class="form-input" v-model="gitRepo" placeholder="输入Git仓库SSH或HTTPS地址">
                    <p class="form-hint">支持 SSH 和 HTTPS 两种方式</p>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" @click="closePanel">取消</button>
                    <button class="btn btn-primary" @click="saveRepoConfig">保存配置</button>
                </div>
            </div>

            <div v-if="panelType === 'theme'">
                <div class="section-title">
                    <i data-lucide="palette" style="width: 16px; height: 16px;"></i>
                    界面主题
                </div>
                <div class="theme-selector">
                    <div class="theme-option" :class="{ 'active': currentTheme === 'light' }" @click="setTheme('light')">
                        <div class="theme-option-preview" style="background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); border: 1px solid #e5e7eb;"></div>
                        <div class="theme-option-name">浅色</div>
                    </div>
                    <div class="theme-option" :class="{ 'active': currentTheme === 'dark' }" @click="setTheme('dark')">
                        <div class="theme-option-preview" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);"></div>
                        <div class="theme-option-name">深色</div>
                    </div>
                    <div class="theme-option" :class="{ 'active': currentTheme === 'purple' }" @click="setTheme('purple')">
                        <div class="theme-option-preview" style="background: linear-gradient(135deg, #1e1b2e 0%, #2d2640 100%);"></div>
                        <div class="theme-option-name">紫色</div>
                    </div>
                    <div class="theme-option" :class="{ 'active': currentTheme === 'green' }" @click="setTheme('green')">
                        <div class="theme-option-preview" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);"></div>
                        <div class="theme-option-name">绿色</div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <div class="section-title">
                    <i data-lucide="code" style="width: 16px; height: 16px;"></i>
                    代码高亮主题
                </div>
                <div class="code-theme-selector">
                    <div class="code-theme-option" :class="{ 'active': codeTheme === 'github' }" @click="setCodeTheme('github')">GitHub</div>
                    <div class="code-theme-option" :class="{ 'active': codeTheme === 'atom-one-dark' }" @click="setCodeTheme('atom-one-dark')">Atom Dark</div>
                    <div class="code-theme-option" :class="{ 'active': codeTheme === 'atom-one-light' }" @click="setCodeTheme('atom-one-light')">Atom Light</div>
                    <div class="code-theme-option" :class="{ 'active': codeTheme === 'monokai' }" @click="setCodeTheme('monokai')">Monokai</div>
                    <div class="code-theme-option" :class="{ 'active': codeTheme === 'vs2015' }" @click="setCodeTheme('vs2015')">VS2015</div>
                    <div class="code-theme-option" :class="{ 'active': codeTheme === 'wechat' }" @click="setCodeTheme('wechat')">微信</div>
                </div>

                <div class="section-divider"></div>

                <div class="section-title">
                    <i data-lucide="edit-3" style="width: 16px; height: 16px;"></i>
                    编辑器模式
                </div>
                <div class="editor-mode-selector">
                    <div class="editor-mode-option" :class="{ 'active': editorMode === 'wysiwyg' }" @click="setEditorMode('wysiwyg')">
                        <i data-lucide="eye" style="width: 14px; height: 14px;"></i>
                        所见即所得
                    </div>
                    <div class="editor-mode-option" :class="{ 'active': editorMode === 'ir' }" @click="setEditorMode('ir')">
                        <i data-lucide="columns" style="width: 14px; height: 14px;"></i>
                        即时渲染
                    </div>
                    <div class="editor-mode-option" :class="{ 'active': editorMode === 'sv' }" @click="setEditorMode('sv')">
                        <i data-lucide="file-text" style="width: 14px; height: 14px;"></i>
                        分屏预览
                    </div>
                </div>

                <div class="section-divider"></div>

                <div class="section-title">
                    <i data-lucide="share-2" style="width: 16px; height: 16px;"></i>
                    导出功能
                </div>
                <div class="export-buttons">
                    <button class="export-btn wechat" @click="exportToWechat()" :disabled="!editingFilePath">
                        <i data-lucide="message-circle" style="width: 14px; height: 14px;"></i>
                        微信公众号
                    </button>
                    <button class="export-btn" @click="exportToHTML()" :disabled="!editingFilePath">
                        <i data-lucide="file-code" style="width: 14px; height: 14px;"></i>
                        导出 HTML
                    </button>
                    <button class="export-btn" @click="copyAsMarkdown()" :disabled="!editingFilePath">
                        <i data-lucide="clipboard" style="width: 14px; height: 14px;"></i>
                        复制 Markdown
                    </button>
                </div>
            </div>

            <div v-if="panelType === 'changes'">
                <div v-if="changes.length === 0" class="empty-state" style="height: 200px;">
                    <i data-lucide="check-circle" style="width: 32px; height: 32px; color: #10b981;"></i>
                    <h3 style="color: #10b981;">没有待提交的更改</h3>
                </div>
                <div v-else>
                    <ul class="changes-list">
                        <li v-for="change in changes" :key="change">
                            <span class="change-icon modified">
                                <i data-lucide="edit-2" style="width: 10px; height: 10px;"></i>
                            </span>
                            {{ change }}
                        </li>
                    </ul>
                    <div class="form-actions">
                        <button class="btn btn-secondary" @click="closePanel">取消</button>
                        <button class="btn btn-success" @click="commit">提交变更</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="contextMenuVisible" class="context-menu" :style="{ top: contextMenuY + 'px', left: contextMenuX + 'px' }">
        <div class="context-menu-item" @click="openFile" v-if="contextMenuFile && contextMenuFile.type === 'file'">
            <i data-lucide="file-text" style="width: 14px; height: 14px;"></i>
            <span>打开</span>
        </div>
        <template v-if="contextMenuFile && contextMenuFile.type === 'directory'">
            <div class="context-menu-item" @click="selectDirectory(contextMenuFile.path)">
                <i data-lucide="folder-open" style="width: 14px; height: 14px;"></i>
                <span>设为当前目录</span>
            </div>
            <div class="context-menu-item" @click="newFileAtContext">
                <i data-lucide="file-plus" style="width: 14px; height: 14px;"></i>
                <span>新建文件</span>
            </div>
            <div class="context-menu-item" @click="newFolderAtContext">
                <i data-lucide="folder-plus" style="width: 14px; height: 14px;"></i>
                <span>新建文件夹</span>
            </div>
        </template>
        <div class="context-menu-item" @click="renameContext">
            <i data-lucide="edit-3" style="width: 14px; height: 14px;"></i>
            <span>重命名</span>
        </div>
        <div class="context-menu-item" @click="moveContext">
            <i data-lucide="move" style="width: 14px; height: 14px;"></i>
            <span>移动</span>
        </div>
        <div class="context-menu-item danger" @click="deleteContext">
            <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
            <span>删除</span>
        </div>
    </div>

    <div class="toast" :class="[toastType, { 'show': toastVisible }]">
        <i :data-lucide="toastIcon" style="width: 16px; height: 16px;"></i>
        <span>{{ toastMessage }}</span>
    </div>

    <div v-if="modalVisible" class="modal-overlay" @click.self="cancelModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon" :class="modalType">
                    <i :data-lucide="modalIcon" style="width: 20px; height: 20px;"></i>
                </div>
                <span class="modal-title">{{ modalTitle }}</span>
            </div>
            <div class="modal-body">
                <p class="modal-message">{{ modalMessage }}</p>
                <div v-if="modalDetails && modalDetails.length" class="modal-details">
                    <ul>
                        <li v-for="detail in modalDetails" :key="detail">{{ detail }}</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="cancelModal">取消</button>
                <button class="btn" :class="modalConfirmClass" @click="confirmModal">确认</button>
            </div>
        </div>
    </div>
</div>
<script src="/static/main.js"></script>
</body>
</html>
