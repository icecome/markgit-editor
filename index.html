<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MarkGit Editor</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%233b82f6;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='8' fill='url(%23grad)'/%3E%3Cg fill='white'%3E%3Cpath d='M12 8v16h8V8h-8z'/%3E%3Cpath d='M8 12h16v8H8z'/%3E%3C/g%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/vditor@3.9.0/dist/index.css">
    <script src="https://unpkg.com/vditor@3.9.0/dist/index.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f9fafb; color: #374151; line-height: 1.6; font-weight: 400; }
        .navbar { position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(229, 231, 235, 0.5); height: 64px; }
        .navbar-content { max-width: 1600px; margin: 0 auto; padding: 0 24px; height: 100%; display: flex; align-items: center; justify-content: space-between; }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 600; color: #111827; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; }
        .nav-actions { display: flex; align-items: center; gap: 8px; }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; border: none; outline: none; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover { background: #e5e7eb; transform: translateY(-1px); }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-ghost { background: transparent; color: #6b7280; }
        .btn-ghost:hover { background: #f3f4f6; color: #374151; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .main-container { display: flex; padding-top: 64px; min-height: 100vh; }
        .sidebar { width: 280px; background: white; border-right: 1px solid #e5e7eb; height: calc(100vh - 64px); position: fixed; left: 0; top: 64px; display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 40; }
        .sidebar.collapsed { transform: translateX(-280px); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #f3f4f6; }
        .sidebar-title { font-size: 14px; font-weight: 600; color: #111827; margin-bottom: 12px; }
        .sidebar-actions { display: flex; gap: 8px; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 12px; }
        .sidebar-footer { padding: 16px 20px; border-top: 1px solid #f3f4f6; background: #f9fafb; }
        .file-tree { font-size: 13px; user-select: none; }
        .tree-item { padding: 6px 10px; cursor: pointer; display: flex; align-items: center; border-radius: 8px; margin: 2px 0; transition: all 0.15s ease; }
        .tree-item:hover { background: #f3f4f6; }
        .tree-item.selected { background: #eff6ff; color: #3b82f6; }
        .tree-item.editing { background: #ecfdf5; color: #059669; }
        .tree-icon { width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; margin-right: 6px; flex-shrink: 0; color: #9ca3af; }
        .tree-item.selected .tree-icon { color: #3b82f6; }
        .tree-toggle { width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center; margin-right: 2px; cursor: pointer; color: #9ca3af; flex-shrink: 0; font-size: 10px; transition: transform 0.2s ease; }
        .tree-toggle:hover { color: #3b82f6; }
        .tree-toggle.expanded { transform: rotate(90deg); }
        .tree-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .tree-actions { opacity: 0; transition: opacity 0.15s ease; display: flex; align-items: center; gap: 2px; }
        .tree-item:hover .tree-actions { opacity: 1; }
        .tree-action-btn { padding: 4px 6px; color: #9ca3af; cursor: pointer; border-radius: 4px; transition: all 0.15s ease; }
        .tree-action-btn:hover { color: #3b82f6; background: #e5e7eb; }
        .tree-action-btn.delete:hover { color: #ef4444; background: #fee2e2; }
        .tree-children { overflow: hidden; }
        .file-size { font-size: 11px; color: #9ca3af; margin-left: 8px; }
        .main-content { flex: 1; margin-left: 280px; min-height: calc(100vh - 64px); transition: margin-left 0.3s ease; }
        .main-content.expanded { margin-left: 0; }
        .content-area { padding: 24px; max-width: 1200px; margin: 0 auto; }
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.02), 0 2px 6px rgba(0, 0, 0, 0.03); display: flex; align-items: center; gap: 16px; transition: all 0.2s ease; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.04), 0 4px 10px rgba(0, 0, 0, 0.05); }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .stat-icon.blue { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); color: #3b82f6; }
        .stat-icon.green { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); color: #10b981; }
        .stat-icon.purple { background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); color: #8b5cf6; }
        .stat-content h3 { font-size: 24px; font-weight: 600; color: #111827; line-height: 1.2; }
        .stat-content p { font-size: 13px; color: #6b7280; margin-top: 2px; }
        .editor-container { background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.02), 0 2px 6px rgba(0, 0, 0, 0.03); overflow: visible; height: calc(100vh - 160px); display: flex; flex-direction: column; }
        .editor-header { padding: 12px 20px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; justify-content: space-between; background: #fafafa; position: relative; z-index: 1; }
        .editor-file-info { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #6b7280; }
        .editor-file-path { font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace; font-size: 12px; background: #f3f4f6; padding: 4px 8px; border-radius: 4px; }
        .editor-content { flex: 1; overflow: visible; position: relative; }
        .vditor { height: 100%; display: flex; flex-direction: column; border-radius: 0 0 12px 12px; overflow: visible; }
        .vditor-content { overflow: hidden; flex: 1; }
        #vditor { height: 100%; border: none; }
        .vditor-toolbar { border-bottom: 1px solid #f3f4f6; background: #fafafa; padding: 8px 12px; overflow: visible; position: relative; z-index: 50; }
        .vditor-toolbar__item { overflow: visible; }
        .vditor-tooltipped::after, .vditor-tooltipped::before { position: absolute !important; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #9ca3af; text-align: center; padding: 40px; }
        .empty-state h3 { font-size: 18px; font-weight: 500; color: #6b7280; margin-bottom: 8px; }
        .empty-state p { font-size: 14px; color: #9ca3af; }
        .side-panel { position: fixed; top: 64px; right: 0; width: 400px; height: calc(100vh - 64px); background: white; box-shadow: -4px 0 20px rgba(0, 0, 0, 0.08); z-index: 100; transform: translateX(100%); transition: transform 0.3s ease; display: flex; flex-direction: column; }
        .side-panel.open { transform: translateX(0); }
        .side-panel-header { padding: 20px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
        .side-panel-title { font-size: 16px; font-weight: 600; color: #111827; }
        .side-panel-close { cursor: pointer; color: #9ca3af; transition: color 0.15s ease; }
        .side-panel-close:hover { color: #374151; }
        .side-panel-content { padding: 20px; overflow-y: auto; flex: 1; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.15s ease; background: white; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .form-textarea { width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; min-height: 150px; resize: vertical; transition: all 0.15s ease; font-family: inherit; }
        .form-textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .form-hint { font-size: 12px; color: #9ca3af; margin-top: 6px; }
        .form-actions { display: flex; gap: 8px; margin-top: 24px; }
        .context-menu { position: fixed; background: white; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); z-index: 1000; min-width: 180px; padding: 6px; border: 1px solid #f3f4f6; }
        .context-menu-item { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px; border-radius: 6px; transition: all 0.15s ease; }
        .context-menu-item:hover { background: #f3f4f6; }
        .context-menu-item.danger { color: #ef4444; }
        .context-menu-item.danger:hover { background: #fee2e2; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.2); z-index: 90; backdrop-filter: blur(2px); }
        .changes-list { list-style: none; padding: 0; margin: 0; }
        .changes-list li { padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .changes-list li:last-child { border-bottom: none; }
        .change-icon { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .change-icon.modified { background: #fef3c7; color: #f59e0b; }
        .loading { display: flex; align-items: center; justify-content: center; height: 200px; }
        .loading-spinner { width: 32px; height: 32px; border: 3px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { position: fixed; top: 80px; right: 24px; padding: 12px 20px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); z-index: 200; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; transform: translateX(120%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .toast.success { background: #ecfdf5; color: #059669; border: 1px solid #d1fae5; }
        .toast.error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .toast.info { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; }
        .sidebar-toggle { position: fixed; left: 280px; top: 80px; width: 24px; height: 24px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 45; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
        .sidebar-toggle:hover { background: #f3f4f6; }
        .sidebar-toggle.collapsed { left: 12px; }
        .current-path-indicator { font-size: 12px; color: #6b7280; background: #f3f4f6; padding: 6px 10px; border-radius: 6px; margin-bottom: 12px; }
        @media (max-width: 1024px) {
            .stats-row { grid-template-columns: 1fr; }
            .sidebar { transform: translateX(-280px); }
            .sidebar.open-mobile { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .sidebar-toggle { left: 12px; }
        }
        @media (max-width: 640px) {
            .navbar-content { padding: 0 16px; }
            .nav-actions { gap: 4px; }
            .btn { padding: 6px 12px; font-size: 12px; }
            .side-panel { width: 100%; }
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); z-index: 150; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); max-width: 420px; width: 90%; overflow: hidden; animation: modalIn 0.2s ease; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(-10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 12px; }
        .modal-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .modal-icon.warning { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #f59e0b; }
        .modal-icon.danger { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #ef4444; }
        .modal-icon.info { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #3b82f6; }
        .modal-title { font-size: 16px; font-weight: 600; color: #111827; }
        .modal-body { padding: 20px 24px; }
        .modal-message { font-size: 14px; color: #374151; line-height: 1.6; }
        .modal-details { margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 13px; color: #6b7280; }
        .modal-details ul { margin: 8px 0 0 0; padding-left: 16px; }
        .modal-details li { margin: 4px 0; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #f3f4f6; display: flex; justify-content: flex-end; gap: 8px; background: #fafafa; }
    </style>
</head>
<body>
<div id="app">
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">
                <div class="logo-icon">
                    <i data-lucide="edit-3" style="width: 18px; height: 18px;"></i>
                </div>
                <span>MarkGit Editor</span>
            </div>
            <div class="nav-actions">
                <button class="btn btn-primary" @click="showNewFilePanel()">
                    <i data-lucide="plus" style="width: 14px; height: 14px;"></i>
                    <span>新建文件</span>
                </button>
                <button class="btn btn-success" @click="showChangesPanel()">
                    <i data-lucide="git-commit" style="width: 14px; height: 14px;"></i>
                    <span>提交</span>
                </button>
                <button class="btn btn-ghost" @click="initWorkspace()" title="初始化仓库（自动克隆远程仓库）">
                    <i data-lucide="git-branch-plus" style="width: 14px; height: 14px;"></i>
                    <span>初始化</span>
                </button>
                <button class="btn btn-ghost" @click="pullRepo()" title="拉取更新">
                    <i data-lucide="git-pull-request" style="width: 14px; height: 14px;"></i>
                    <span>拉取</span>
                </button>
                <button class="btn btn-ghost" @click="showConfigPanel()" title="设置">
                    <i data-lucide="settings" style="width: 14px; height: 14px;"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="sidebar-toggle" :class="{ 'collapsed': sidebarCollapsed }" @click="toggleSidebar">
            <i data-lucide="chevron-left" style="width: 14px; height: 14px;" v-if="!sidebarCollapsed"></i>
            <i data-lucide="chevron-right" style="width: 14px; height: 14px;" v-else></i>
        </div>

        <div class="sidebar" :class="{ 'collapsed': sidebarCollapsed }">
            <div class="sidebar-header">
                <div class="sidebar-title">文件浏览器</div>
                <div class="sidebar-actions">
                    <button class="btn btn-sm btn-secondary" @click="showNewFolderPanel()" title="在当前目录新建文件夹">
                        <i data-lucide="folder-plus" style="width: 12px; height: 12px;"></i>
                    </button>
                    <button class="btn btn-sm btn-secondary" @click="showNewFilePanel()" title="在当前目录新建文件">
                        <i data-lucide="file-plus" style="width: 12px; height: 12px;"></i>
                    </button>
                </div>
            </div>

            <div class="current-path-indicator" style="margin: 12px;">
                <i data-lucide="folder" style="width: 12px; height: 12px; display: inline; vertical-align: middle;"></i>
                当前目录: {{ currentDirectory || '根目录' }}
            </div>

            <div class="sidebar-content">
                <div v-if="loading" class="loading">
                    <div class="loading-spinner"></div>
                </div>
                <div v-else-if="fileTree.length === 0" class="empty-state">
                    <i data-lucide="folder-open" style="width: 32px; height: 32px;"></i>
                    <p>仓库为空</p>
                </div>
                <div v-else class="file-tree">
                    <tree-node
                        v-for="node in fileTree"
                        :key="node.path"
                        :node="node"
                        :level="0"
                        :expanded-paths="expandedPaths"
                        :selected-path="selectedFile ? selectedFile.path : ''"
                        :editing-path="editingFilePath"
                        :current-directory="currentDirectory"
                        @toggle="toggleExpand"
                        @select="selectFile"
                        @select-directory="selectDirectory"
                        @rename="showRenamePanel"
                        @delete="deleteFile"
                        @move="showMovePanel"
                        @contextmenu="showContextMenu"
                        @newfile="showNewFilePanelAt"
                        @newfolder="showNewFolderPanelAt"
                    ></tree-node>
                </div>
            </div>

            <div class="sidebar-footer">
                <div style="font-size: 12px; color: #9ca3af;">
                    <i data-lucide="git-branch" style="width: 12px; height: 12px; display: inline; vertical-align: middle;"></i>
                    {{ gitRepo ? gitRepo.split('/').pop().replace('.git', '') : '未配置' }}
                </div>
            </div>
        </div>

        <div class="main-content" :class="{ 'expanded': sidebarCollapsed }">
            <div class="content-area">
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <i data-lucide="file-text" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ fileCount }}</h3>
                            <p>文件总数</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <i data-lucide="folder" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ folderCount }}</h3>
                            <p>文件夹</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <i data-lucide="git-commit" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ changes.length }}</h3>
                            <p>待提交</p>
                        </div>
                    </div>
                </div>

                <div class="editor-container">
                    <div v-if="!editingFilePath" class="empty-state">
                        <i data-lucide="file-text" style="width: 48px; height: 48px;"></i>
                        <h3>选择文件开始编辑</h3>
                        <p>从左侧文件浏览器中选择一个文件</p>
                    </div>
                    <template v-else>
                        <div class="editor-header">
                            <div class="editor-file-info">
                                <i data-lucide="file-text" style="width: 16px; height: 16px; color: #3b82f6;"></i>
                                <span class="editor-file-path">{{ editingFilePath }}</span>
                            </div>
                            <button class="btn btn-sm btn-success" @click="saveFile()">
                                <i data-lucide="save" style="width: 12px; height: 12px;"></i>
                                <span>保存</span>
                            </button>
                        </div>
                        <div class="editor-content">
                            <div id="vditor"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <div v-if="panelOpen" class="overlay" @click="closePanel"></div>

    <div class="side-panel" :class="{ 'open': panelOpen }">
        <div class="side-panel-header">
            <span class="side-panel-title">{{ panelTitle }}</span>
            <span class="side-panel-close" @click="closePanel">
                <i data-lucide="x" style="width: 18px; height: 18px;"></i>
            </span>
        </div>
        <div class="side-panel-content">
            <div v-if="panelType === 'newfile'">
                <div class="form-group">
                    <label class="form-label">文件名</label>
                    <input type="text" class="form-input" v-model="newFileName" placeholder="例如: my-post.md" @keyup.enter="createFile">
                    <p class="form-hint">将创建在: {{ currentDirectory || '根目录' }}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">文件内容（可选）</label>
                    <textarea class="form-textarea" v-model="newFileContent" placeholder="输入文件内容..."></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" @click="closePanel">取消</button>
                    <button class="btn btn-primary" @click="createFile">创建文件</button>
                </div>
            </div>

            <div v-if="panelType === 'newfolder'">
                <div class="form-group">
                    <label class="form-label">文件夹名</label>
                    <input type="text" class="form-input" v-model="newFolderName" placeholder="例如: my-folder" @keyup.enter="createFolder">
                    <p class="form-hint">将创建在: {{ currentDirectory || '根目录' }}</p>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" @click="closePanel">取消</button>
                    <button class="btn btn-primary" @click="createFolder">创建文件夹</button>
                </div>
            </div>

            <div v-if="panelType === 'rename'">
                <div class="form-group">
                    <label class="form-label">新名称</label>
                    <input type="text" class="form-input" v-model="renameNewName" @keyup.enter="renameFile">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" @click="closePanel">取消</button>
                    <button class="btn btn-primary" @click="renameFile">确认重命名</button>
                </div>
            </div>

            <div v-if="panelType === 'move'">
                <div class="form-group">
                    <label class="form-label">目标路径</label>
                    <input type="text" class="form-input" v-model="moveDestPath">
                    <p class="form-hint">原路径: {{ moveSourcePath }}</p>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" @click="closePanel">取消</button>
                    <button class="btn btn-primary" @click="moveFile">确认移动</button>
                </div>
            </div>

            <div v-if="panelType === 'config'">
                <div class="form-group">
                    <label class="form-label">Git仓库地址</label>
                    <input type="text" class="form-input" v-model="gitRepo" placeholder="输入Git仓库SSH或HTTPS地址">
                    <p class="form-hint">支持SSH和HTTPS两种方式</p>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" @click="closePanel">取消</button>
                    <button class="btn btn-primary" @click="saveRepoConfig">保存配置</button>
                </div>
            </div>

            <div v-if="panelType === 'changes'">
                <div v-if="changes.length === 0" class="empty-state" style="height: 200px;">
                    <i data-lucide="check-circle" style="width: 32px; height: 32px; color: #10b981;"></i>
                    <h3 style="color: #10b981;">没有待提交的更改</h3>
                </div>
                <div v-else>
                    <ul class="changes-list">
                        <li v-for="change in changes" :key="change">
                            <span class="change-icon modified">
                                <i data-lucide="edit-2" style="width: 10px; height: 10px;"></i>
                            </span>
                            {{ change }}
                        </li>
                    </ul>
                    <div class="form-actions">
                        <button class="btn btn-secondary" @click="closePanel">取消</button>
                        <button class="btn btn-success" @click="commit">提交变更</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="contextMenuVisible" class="context-menu" :style="{ top: contextMenuY + 'px', left: contextMenuX + 'px' }">
        <div class="context-menu-item" @click="openFile" v-if="contextMenuFile && contextMenuFile.type === 'file'">
            <i data-lucide="file-text" style="width: 14px; height: 14px;"></i>
            <span>打开</span>
        </div>
        <template v-if="contextMenuFile && contextMenuFile.type === 'directory'">
            <div class="context-menu-item" @click="selectDirectory(contextMenuFile.path)">
                <i data-lucide="folder-open" style="width: 14px; height: 14px;"></i>
                <span>设为当前目录</span>
            </div>
            <div class="context-menu-item" @click="newFileAtContext">
                <i data-lucide="file-plus" style="width: 14px; height: 14px;"></i>
                <span>新建文件</span>
            </div>
            <div class="context-menu-item" @click="newFolderAtContext">
                <i data-lucide="folder-plus" style="width: 14px; height: 14px;"></i>
                <span>新建文件夹</span>
            </div>
        </template>
        <div class="context-menu-item" @click="renameContext">
            <i data-lucide="edit-3" style="width: 14px; height: 14px;"></i>
            <span>重命名</span>
        </div>
        <div class="context-menu-item" @click="moveContext">
            <i data-lucide="move" style="width: 14px; height: 14px;"></i>
            <span>移动</span>
        </div>
        <div class="context-menu-item danger" @click="deleteContext">
            <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
            <span>删除</span>
        </div>
    </div>

    <div class="toast" :class="[toastType, { 'show': toastVisible }]">
        <i :data-lucide="toastIcon" style="width: 16px; height: 16px;"></i>
        <span>{{ toastMessage }}</span>
    </div>

    <div v-if="modalVisible" class="modal-overlay" @click.self="cancelModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon" :class="modalType">
                    <i :data-lucide="modalIcon" style="width: 20px; height: 20px;"></i>
                </div>
                <span class="modal-title">{{ modalTitle }}</span>
            </div>
            <div class="modal-body">
                <p class="modal-message">{{ modalMessage }}</p>
                <div v-if="modalDetails && modalDetails.length" class="modal-details">
                    <ul>
                        <li v-for="detail in modalDetails" :key="detail">{{ detail }}</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="cancelModal">取消</button>
                <button class="btn" :class="modalConfirmClass" @click="confirmModal">确认</button>
            </div>
        </div>
    </div>
</div>

<script>
lucide.createIcons();

const TreeNode = {
    name: 'TreeNode',
    props: {
        node: Object,
        level: Number,
        expandedPaths: Object,
        selectedPath: String,
        editingPath: String,
        currentDirectory: String
    },
    emits: ['toggle', 'select', 'selectDirectory', 'rename', 'delete', 'move', 'contextmenu', 'newfile', 'newfolder'],
    computed: {
        isExpanded() { return this.expandedPaths.has(this.node.path); },
        isSelected() { return this.selectedPath === this.node.path; },
        isEditing() { return this.editingPath === this.node.path; },
        isCurrentDirectory() { return this.currentDirectory === this.node.path; },
        hasChildren() { return this.node.children && this.node.children.length > 0; },
        indentStyle() { return { paddingLeft: (this.level * 16) + 'px' }; }
    },
    methods: {
        toggle() { if (this.node.type === 'directory') this.$emit('toggle', this.node.path); },
        select() {
            if (this.node.type === 'file') { this.$emit('select', this.node); }
            else { this.$emit('selectDirectory', this.node.path); this.toggle(); }
        },
        onContextmenu(e) { e.preventDefault(); e.stopPropagation(); this.$emit('contextmenu', e, this.node); },
        formatSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
    },
    template: `
        <div>
            <div class="tree-item" :class="{ 'selected': isSelected || isCurrentDirectory, 'editing': isEditing }" :style="indentStyle" @click="select" @contextmenu="onContextmenu">
                <span class="tree-toggle" v-if="node.type === 'directory'" @click.stop="toggle" :class="{ 'expanded': isExpanded }">
                    <svg v-if="hasChildren" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </span>
                <span class="tree-toggle" v-else></span>
                <span class="tree-icon">
                    <svg v-if="node.type === 'directory'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                    <svg v-else xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                </span>
                <span class="tree-name">{{ node.name }}</span>
                <span v-if="node.type === 'file' && node.size" class="file-size">{{ formatSize(node.size) }}</span>
                <div class="tree-actions">
                    <span class="tree-action-btn" @click.stop="$emit('rename', node)" title="重命名">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </span>
                    <span class="tree-action-btn delete" @click.stop="$emit('delete', node)" title="删除">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </span>
                </div>
            </div>
            <div v-if="node.type === 'directory' && hasChildren && isExpanded" class="tree-children">
                <tree-node v-for="child in node.children" :key="child.path" :node="child" :level="level + 1" :expanded-paths="expandedPaths" :selected-path="selectedPath" :editing-path="editingPath" :current-directory="currentDirectory" @toggle="$emit('toggle', $event)" @select="$emit('select', $event)" @select-directory="$emit('selectDirectory', $event)" @rename="$emit('rename', $event)" @delete="$emit('delete', $event)" @move="$emit('move', $event)" @contextmenu="$emit('contextmenu', $event, $event)" @newfile="$emit('newfile', $event)" @newfolder="$emit('newfolder', $event)"></tree-node>
            </div>
        </div>
    `
};

if (typeof Vue !== 'undefined') {
    const { createApp } = Vue;
    const app = createApp({
        components: { TreeNode },
        data() {
            return {
                contentEditor: null, files: [], fileTree: [], expandedPaths: new Set(),
                selectedFile: null, editingFilePath: '', currentDirectory: '', changes: [],
                loading: false, gitRepo: localStorage.getItem('gitRepo') || '', sidebarCollapsed: false, panelOpen: false,
                panelType: '', panelTitle: '', newFileName: '', newFileContent: '',
                newFolderName: '', renameFile_: null, renameNewName: '', moveFile_: null,
                moveSourcePath: '', moveDestPath: '', contextMenuVisible: false,
                contextMenuX: 0, contextMenuY: 0, contextMenuFile: null,
                toastVisible: false, toastMessage: '', toastType: 'info', toastIcon: 'info',
                modalVisible: false, modalTitle: '', modalMessage: '', modalType: 'info',
                modalIcon: 'info', modalDetails: [], modalConfirmClass: 'btn-primary',
                modalCallback: null, modalFile_: null
            };
        },
        computed: {
            fileCount() { return this.files.filter(f => f.type === 'file').length; },
            folderCount() { return this.files.filter(f => f.type === 'directory').length; }
        },
        methods: {
            toggleSidebar() { this.sidebarCollapsed = !this.sidebarCollapsed; },
            selectDirectory(path) { this.currentDirectory = path; this.hideContextMenu(); },
            async commit() {
                try { await axios.post('/api/commit'); this.closePanel(); this.showToast('提交成功', 'success'); this.changes = []; }
                catch (error) { this.errorHandler(error); }
            },
            async showChangesPanel() {
                try { const response = await axios.get('/api/posts/changes'); this.changes = response.data; this.panelTitle = '提交变更'; this.panelType = 'changes'; this.panelOpen = true; this.$nextTick(() => lucide.createIcons()); }
                catch (error) { this.errorHandler(error); }
            },
            async saveFile() {
                if (!this.editingFilePath || !this.contentEditor) return;
                try { await axios.post('/api/file/save', { path: this.editingFilePath, content: this.contentEditor.getValue() }); this.showToast('保存成功', 'success'); }
                catch (error) { this.errorHandler(error); }
            },
            async selectFile(file) {
                await this.saveFile();
                this.selectedFile = file;
                this.editingFilePath = file.path;
                this.loading = true;
                try { const response = await axios.get('/api/file/content', { params: { file_path: file.path } }); await this.$nextTick(); this.createEditor(file.path, response.data); }
                catch (error) { this.errorHandler(error); }
                finally { this.loading = false; }
            },
            toggleExpand(path) {
                if (this.expandedPaths.has(path)) this.expandedPaths.delete(path);
                else this.expandedPaths.add(path);
                this.expandedPaths = new Set(this.expandedPaths);
            },
            async initWorkspace() {
                if (!this.gitRepo) {
                    this.showToast('请先配置Git仓库地址', 'error');
                    return;
                }
                this.showModal({
                    title: '初始化仓库',
                    message: '是否确定初始化仓库？',
                    type: 'info',
                    icon: 'git-branch-plus',
                    details: ['如果已配置远程仓库地址，将自动克隆到本地', '如果本地已有文件，将被保留'],
                    confirmClass: 'btn-primary',
                    callback: async () => {
                        try {
                            // 传递仓库地址给后端
                            const response = await axios.post('/api/init', { gitRepo: this.gitRepo });
                            await this.getFiles();
                            this.showToast(response.data.message || '初始化成功', 'success');
                        } catch (error) { this.errorHandler(error); }
                    }
                });
            },
            async pullRepo() {
                try { await axios.post('/api/pull'); await this.getFiles(); this.showToast('拉取成功', 'success'); }
                catch (error) { this.errorHandler(error); }
            },
            showNewFilePanel() { this.newFileName = ''; this.newFileContent = ''; this.panelTitle = '新建文件'; this.panelType = 'newfile'; this.panelOpen = true; this.$nextTick(() => lucide.createIcons()); },
            showNewFilePanelAt(path) { this.currentDirectory = path; this.newFileName = ''; this.newFileContent = ''; this.panelTitle = '新建文件'; this.panelType = 'newfile'; this.panelOpen = true; this.hideContextMenu(); this.$nextTick(() => lucide.createIcons()); },
            showNewFolderPanel() { this.newFolderName = ''; this.panelTitle = '新建文件夹'; this.panelType = 'newfolder'; this.panelOpen = true; this.$nextTick(() => lucide.createIcons()); },
            showNewFolderPanelAt(path) { this.currentDirectory = path; this.newFolderName = ''; this.panelTitle = '新建文件夹'; this.panelType = 'newfolder'; this.panelOpen = true; this.hideContextMenu(); this.$nextTick(() => lucide.createIcons()); },
            showConfigPanel() { this.panelTitle = 'Git仓库配置'; this.panelType = 'config'; this.panelOpen = true; this.$nextTick(() => lucide.createIcons()); },
            showRenamePanel(file) { this.renameFile_ = file; this.renameNewName = file.name; this.panelTitle = '重命名'; this.panelType = 'rename'; this.panelOpen = true; this.hideContextMenu(); this.$nextTick(() => lucide.createIcons()); },
            showMovePanel(file) { this.moveFile_ = file; this.moveSourcePath = file.path; this.moveDestPath = file.path; this.panelTitle = '移动文件'; this.panelType = 'move'; this.panelOpen = true; this.hideContextMenu(); this.$nextTick(() => lucide.createIcons()); },
            closePanel() { this.panelOpen = false; this.panelType = ''; },
            async createFile() {
                if (!this.newFileName) { this.showToast('请输入文件名', 'error'); return; }
                const fullPath = this.currentDirectory ? this.currentDirectory + '/' + this.newFileName : this.newFileName;
                try { await axios.post('/api/file/create', { path: fullPath, content: this.newFileContent }); this.closePanel(); await this.getFiles(); if (this.currentDirectory) { this.expandedPaths.add(this.currentDirectory); this.expandedPaths = new Set(this.expandedPaths); } this.showToast('文件创建成功', 'success'); }
                catch (error) { this.errorHandler(error); }
            },
            async createFolder() {
                if (!this.newFolderName) { this.showToast('请输入文件夹名', 'error'); return; }
                const fullPath = this.currentDirectory ? this.currentDirectory + '/' + this.newFolderName : this.newFolderName;
                try { await axios.post('/api/folder/create', { path: fullPath }); this.closePanel(); await this.getFiles(); if (this.currentDirectory) { this.expandedPaths.add(this.currentDirectory); this.expandedPaths = new Set(this.expandedPaths); } this.showToast('文件夹创建成功', 'success'); }
                catch (error) { this.errorHandler(error); }
            },
            async renameFile() {
                if (!this.renameNewName) { this.showToast('请输入新名称', 'error'); return; }
                const oldPath = this.renameFile_.path;
                const parentPath = oldPath.substring(0, oldPath.lastIndexOf('/'));
                const newPath = parentPath ? parentPath + '/' + this.renameNewName : this.renameNewName;
                try { await axios.post('/api/file/rename', { oldPath: oldPath, newPath: newPath }); this.closePanel(); await this.getFiles(); if (this.editingFilePath === oldPath) this.editingFilePath = newPath; this.showToast('重命名成功', 'success'); }
                catch (error) { this.errorHandler(error); }
            },
            async moveFile() {
                if (!this.moveDestPath) { this.showToast('请输入目标路径', 'error'); return; }
                try { await axios.post('/api/file/move', { sourcePath: this.moveSourcePath, destPath: this.moveDestPath }); this.closePanel(); await this.getFiles(); if (this.editingFilePath === this.moveSourcePath) this.editingFilePath = this.moveDestPath; this.showToast('移动成功', 'success'); }
                catch (error) { this.errorHandler(error); }
            },
            async deleteFile(file) {
                this.showModal({
                    title: '删除确认',
                    message: `确定要删除 "${file.name}" 吗？`,
                    type: 'danger',
                    icon: 'trash-2',
                    confirmClass: 'btn-primary',
                    callback: async () => {
                        try {
                            await axios.delete('/api/file/delete', { params: { file_path: file.path } });
                            if (this.editingFilePath === file.path) {
                                if (this.contentEditor) { this.contentEditor.destroy(); this.contentEditor = null; }
                                this.editingFilePath = '';
                            }
                            await this.getFiles();
                            this.showToast('删除成功', 'success');
                        } catch (error) { this.errorHandler(error); }
                    }
                });
            },
            async getFiles() {
                this.loading = true;
                try { const response = await axios.get('/api/files'); this.files = response.data; this.buildFileTree(); }
                catch (error) { this.errorHandler(error); }
                finally { this.loading = false; }
            },
            buildFileTree() {
                const root = { children: {} };
                const sortedFiles = [...this.files].sort((a, b) => a.path.localeCompare(b.path));
                for (const file of sortedFiles) {
                    const parts = file.path.split('/').filter(p => p);
                    let current = root;
                    let currentPath = '';
                    for (let i = 0; i < parts.length; i++) {
                        const part = parts[i];
                        const isLast = i === parts.length - 1;
                        currentPath = currentPath ? currentPath + '/' + part : part;
                        if (!current.children[part]) {
                            if (isLast) { current.children[part] = { name: part, path: currentPath, type: file.type, size: file.size, children: file.type === 'directory' ? {} : undefined }; }
                            else { current.children[part] = { name: part, path: currentPath, type: 'directory', children: {} }; }
                        } else if (isLast && file.type === 'directory') { current.children[part].type = 'directory'; if (!current.children[part].children) current.children[part].children = {}; }
                        current = current.children[part];
                    }
                }
                const convertToArray = (node) => {
                    if (!node.children) return node;
                    const children = Object.values(node.children).map(convertToArray).sort((a, b) => { if (a.type !== b.type) return a.type === 'directory' ? -1 : 1; return a.name.localeCompare(b.name); });
                    return { ...node, children };
                };
                this.fileTree = Object.values(root.children).map(convertToArray).sort((a, b) => { if (a.type !== b.type) return a.type === 'directory' ? -1 : 1; return a.name.localeCompare(b.name); });
            },
            createEditor(filePath, rawContent) {
                if (this.contentEditor) this.contentEditor.destroy();
                this.contentEditor = new Vditor('vditor', {
                    height: '100%', toolbarConfig: { pin: true }, cache: { enable: false },
                    after: () => { this.contentEditor.setValue(rawContent); },
                    preview: { markdown: { linkBase: filePath.substring(0, filePath.lastIndexOf('/')) } },
                    upload: { url: "/upload", fieldName: "files", max: 20 * 1024 * 1024, extraData: { belongDirName: filePath.substring(0, filePath.lastIndexOf('/')) }, success: (file, response) => { return response.data.succMap[file.name]; } },
                    input: () => { if (this.autoSaveTimer) clearTimeout(this.autoSaveTimer); this.autoSaveTimer = setTimeout(() => { this.saveFile(); }, 2000); },
                    mode: 'wysiwyg', theme: 'classic'
                });
            },
            errorHandler(error) { console.error(error); const message = error.response?.data?.detail || '操作失败，请重试'; this.showToast(message, 'error'); },
            showToast(message, type = 'info') { this.toastMessage = message; this.toastType = type; this.toastIcon = type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info'; this.toastVisible = true; this.$nextTick(() => lucide.createIcons()); setTimeout(() => { this.toastVisible = false; }, 3000); },
            showModal(options) {
                this.modalTitle = options.title || '确认';
                this.modalMessage = options.message || '';
                this.modalType = options.type || 'info';
                this.modalIcon = options.icon || 'info';
                this.modalDetails = options.details || [];
                this.modalConfirmClass = options.confirmClass || 'btn-primary';
                this.modalCallback = options.callback || null;
                this.modalVisible = true;
                this.$nextTick(() => lucide.createIcons());
            },
            confirmModal() {
                this.modalVisible = false;
                if (this.modalCallback) { this.modalCallback(); this.modalCallback = null; }
            },
            cancelModal() {
                this.modalVisible = false;
                this.modalCallback = null;
            },
            saveRepoConfig() { localStorage.setItem('gitRepo', this.gitRepo); axios.post('/api/git-repo', { gitRepo: this.gitRepo }).then(response => { this.closePanel(); this.showToast('配置已保存，请点击初始化按钮', 'success'); }).catch(error => { this.errorHandler(error); }); },
            showContextMenu(event, file) { this.contextMenuVisible = true; this.contextMenuX = event.clientX; this.contextMenuY = event.clientY; this.contextMenuFile = file; this.$nextTick(() => lucide.createIcons()); },
            hideContextMenu() { this.contextMenuVisible = false; this.contextMenuFile = null; },
            openFile() { if (this.contextMenuFile && this.contextMenuFile.type === 'file') this.selectFile(this.contextMenuFile); this.hideContextMenu(); },
            newFileAtContext() { if (this.contextMenuFile) this.showNewFilePanelAt(this.contextMenuFile.path); },
            newFolderAtContext() { if (this.contextMenuFile) this.showNewFolderPanelAt(this.contextMenuFile.path); },
            renameContext() { if (this.contextMenuFile) this.showRenamePanel(this.contextMenuFile); },
            moveContext() { if (this.contextMenuFile) this.showMovePanel(this.contextMenuFile); },
            deleteContext() { if (this.contextMenuFile) this.deleteFile(this.contextMenuFile); }
        },
        async mounted() {
            await this.getFiles();
            try { const response = await axios.get('/api/git-repo'); this.gitRepo = response.data.gitRepo; } catch (error) { console.error('Failed to get git repo config:', error); }
            this._clickHandler = () => { this.hideContextMenu(); };
            document.addEventListener('click', this._clickHandler);
            this.$nextTick(() => lucide.createIcons());
        },
        beforeUnmount() {
            if (this.autoSaveTimer) {
                clearTimeout(this.autoSaveTimer);
                this.autoSaveTimer = null;
            }
            if (this.contentEditor) {
                this.contentEditor.destroy();
                this.contentEditor = null;
            }
            if (this._clickHandler) {
                document.removeEventListener('click', this._clickHandler);
                this._clickHandler = null;
            }
        }
    });
    app.mount('#app');
} else { console.error('Vue is not loaded'); }
</script>
</body>
</html>
